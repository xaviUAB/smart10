<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART 10 Digital (Layout Cercle V7)</title>
    <!-- Inclou Tailwind CSS per a l'estil -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Estil per als discs de resposta (imitaci√≥ 3D) */
        .answer-disc {
            background-color: #1a202c; /* gray-900 */
            border-top: 2px solid #4a5568; /* gray-600 */
            border-bottom: 2px solid #000;
            transition: all 0.15s ease-out;
            transform: scale(1);
            /* Estil del text '?' (Blanc) */
            @apply text-white text-2xl font-bold;
            color: white; /* CANVIAT: For√ßa el color blanc per al '?' */
        }
        .answer-disc:hover {
            background-color: #2d3748; /* gray-800 */
            transform: scale(1.05);
        }
        
        /* Animaci√≥ de parpelleig per al temporitzador */
        @keyframes blink-warning {
            50% { 
                color: #ef4444; /* red-500 */
                transform: scale(1.1);
            }
        }
        .timer-warning {
            animation: blink-warning 1s infinite;
        }
    </style>
</head>

<!-- Cos principal: Fons Ambre clar, centrat i apilat verticalment -->
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen bg-amber-100">

    <!-- CONTENIDOR PRINCIPAL: Taronja (bg-orange-600) -->
    <div class="w-full max-w-5xl bg-orange-600 shadow-2xl rounded-xl p-6 md:p-10 border-4 border-orange-500">

        <!-- Header/Title container -->
        <div class="flex justify-between items-center mb-6 border-b-4 border-gray-900 pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white">
                SMART 10 Digital
            </h1>
            <div class="flex items-center space-x-3">
                <button id="toggle-timer-button" class="w-10 h-10 flex items-center justify-center bg-blue-600 text-white text-2xl rounded-full shadow-lg hover:bg-blue-700 transition-all duration-150 transform hover:scale-110" 
                        aria-label="Activar/Desactivar Temporitzador">
                    ‚è∞
                </button>
                <a href="instruccions.html" 
                   class="w-10 h-10 flex items-center justify-center bg-blue-600 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-110" 
                   aria-label="Instruccions">
                    i
                </a>
            </div>
        </div>

        <!-- ====== 1. √ÄREA DE CONFIGURACI√ì ====== -->
        <div id="game-setup">
            <div class="bg-orange-700 p-6 rounded-lg shadow-inner border-b-4 border-orange-900">
                <h2 class="text-2xl font-bold text-amber-200 mb-4 text-center border-b border-orange-500 pb-2">Configuraci√≥ de la Partida</h2>
                <div class="mb-4">
                    <label for="player-count" class="block text-lg font-bold text-white mb-2">Quants jugadors? (1-4)</label>
                    <select id="player-count" class="w-full p-3 rounded-lg bg-white text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-amber-300">
                        <option value="1" selected>1 Jugador</option>
                        <option value="2">2 Jugadors</option>
                        <option value="3">3 Jugadors</option>
                        <option value="4">4 Jugadors</option>
                    </select>
                </div>
                <div id="player-names-container" class="space-y-3 mb-6">
                    <!-- Els inputs dels noms van aqu√≠ -->
                </div>
                <div class="flex items-center justify-center space-x-2 mt-4">
                    <input type="checkbox" id="enable-timer-checkbox" class="h-5 w-5 rounded text-blue-600 focus:ring-blue-500">
                    <label for="enable-timer-checkbox" class="text-white font-bold">Activar Temporitzador (45s)</label>
                </div>
                <div class="mt-6">
                    <h3 class="text-lg font-bold text-amber-200 mb-3">Tria un o m√©s conjunts de preguntes:</h3>
                    <div id="remote-files-container" class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-40 overflow-y-auto bg-orange-800 p-3 rounded-lg">
                        <p class="text-white italic col-span-full">Carregant llista de fitxers...</p>
                    </div>
                </div>
                <form id="setup-form" class="mt-8 text-center">
                    <button type="submit" class="w-full md:w-auto bg-amber-200 text-gray-900 text-xl font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-white transform hover:scale-105 transition-transform duration-150">
                        Comen√ßar Partida
                    </button>
                </form>
            </div>
            <div id="local-upload-area" class="mt-6 text-center bg-orange-700 p-4 rounded-lg shadow-inner">
                <label for="csv-file" class="block text-lg font-bold text-white mb-2">... o puja el teu propi fitxer CSV:</label>
                <input type="file" id="csv-file" accept=".csv" class="w-full text-sm text-white font-bold
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-amber-200 file:text-gray-900
                    hover:file:bg-white">
            </div>
        </div>

        <!-- ====== 2. √ÄREA DE JOC ====== -->
        <div id="game-area" class="hidden">
            
            <div id="scoreboard" class="flex flex-wrap justify-center gap-2 mb-6 p-4 bg-red-900 bg-opacity-75 rounded-lg shadow-inner">
                <!-- Marcadors -->
            </div>
            
            <div class="bg-orange-700 p-4 md:p-6 rounded-lg shadow-inner border-b-4 border-orange-900">
                
                <div class="flex flex-col md:flex-row items-center md:items-start justify-between gap-4 my-6">
                    
                    <!-- Columna Esquerra (Opcions 1-5) -->
                    <div id="options-col-1" class="space-y-4 w-full md:w-1/3 order-2 md:order-1">
                        <!-- JS fills this -->
                    </div>

                    <div class="flex flex-col items-center order-1 md:order-2">
                        <div id="category-display" class="text-center text-sm font-semibold text-white mb-2">
                            <!-- Categoria de la pregunta -->
                        </div>
                        
                        <!-- CANVIAT: Mida fixa (w-56 h-56 / w-64 h-64) per a un cercle perfecte -->
                        <div class="relative w-56 h-56 md:w-64 md:h-64 bg-white rounded-full flex items-center justify-center p-8 shadow-xl border-4 border-orange-300">
                            <p id="question-text" class="text-xl md:text-2xl font-bold text-gray-900 text-center leading-tight">
                                <!-- Text de la pregunta -->
                            </p>
                        </div>
                    </div>

                    <!-- Columna Dreta (Opcions 6-10) -->
                    <div id="options-col-2" class="space-y-4 w-full md:w-1/3 order-3 md:order-3">
                        <!-- JS fills this -->
                    </div>
                </div>
                
                <div class="turn-indicator-container flex flex-col md:flex-row justify-between items-center bg-red-900 bg-opacity-75 p-3 rounded-lg mt-6 shadow-inner">
                    <div class="flex items-center">
                        <span id="turn-indicator" class="text-xl md:text-2xl font-extrabold text-orange-500">
                            Et toca, Jugador!
                        </span>
                        <div id="timer-display" class="hidden ml-4 text-2xl font-bold text-white">45s</div>
                    </div>
                    
                    <button id="pass-turn-button" class="w-full md:w-auto mt-3 md:mt-0 bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-red-800 transform hover:scale-105 transition-transform duration-150">
                        Em planto (0)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Peu de p√†gina -->
    <footer class="mt-8 text-center text-sm text-gray-700">
        <p>Un desenvolupament de Xavier Ribes amb Gemini pel GameLab</p>
        <p class="mt-1">Departament de Comunicaci√≥ Audiovisual i Publicitat de la UAB</p>
    </footer>

    <!-- ====== 3. MODAL DE RESPOSTA ====== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 max-w-lg w-full text-center border-4 border-yellow-300">
            <p id="correct-answer-text" class="text-3xl font-extrabold text-gray-900 mb-6">
                <!-- Resposta correcta -->
            </p>
            <p class="text-xl font-semibold text-gray-800 mb-6">Has encertat?</p>
            <div class="flex justify-around">
                <button id="correct-button" class="bg-green-600 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700 transform hover:scale-105 transition-transform duration-150">
                    He encertat!
                </button>
                <button id="wrong-button" class="bg-red-600 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-red-700 transform hover:scale-105 transition-transform duration-150">
                    He fallat
                </button>
            </div>
        </div>
    </div>
    
    <!-- ====== 4. MODAL DE FINAL DE PARTIDA ====== -->
    <div id="game-over-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full text-center border-4 border-orange-500">
            <h2 id="game-over-title" class="text-4xl font-extrabold text-orange-600 mb-6">Partida Finalitzada!</h2>
            <p id="game-over-winner" class="text-2xl font-semibold text-gray-900 mb-8">
                <!-- El guanyador √©s [Jugador]! -->
            </p>
            <button id="restart-game-button" class="bg-blue-600 text-white text-xl font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-transform duration-150">
                Tornar a Jugar
            </button>
        </div>
    </div>

    <!-- ====== 5. MODAL: SENSE TEMPS ====== -->
    <div id="time-up-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 md:p-8 max-w-lg w-full text-center border-4 border-red-500">
            <p id="time-up-message" class="text-2xl font-extrabold text-gray-900 mb-6">
                <!-- T'has quedat sense temps, [Jugador]! -->
            </p>
            <button id="time-up-confirm-button" class="bg-red-600 text-white text-lg font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-red-700 transform hover:scale-105 transition-transform duration-150">
                Eliminat de la ronda
            </button>
        </div>
    </div>


    <!-- ====== JAVASCRIPT ====== -->
    <script>
        // --- Constants Globals i IDs d'Elements ---
        const PLAYER_COUNT_SELECT = document.getElementById('player-count');
        const PLAYER_NAMES_CONTAINER = document.getElementById('player-names-container');
        const SETUP_FORM = document.getElementById('setup-form');
        const CSV_FILE_INPUT = document.getElementById('csv-file');
        const GAME_SETUP_AREA = document.getElementById('game-setup');
        const LOCAL_UPLOAD_AREA = document.getElementById('local-upload-area');
        const GAME_AREA = document.getElementById('game-area');
        const SCOREBOARD = document.getElementById('scoreboard');
        const CATEGORY_DISPLAY = document.getElementById('category-display');
        const QUESTION_TEXT = document.getElementById('question-text');
        const TURN_INDICATOR = document.getElementById('turn-indicator');
        const PASS_TURN_BUTTON = document.getElementById('pass-turn-button');
        const OPTIONS_CONTAINER_1 = document.getElementById('options-col-1');
        const OPTIONS_CONTAINER_2 = document.getElementById('options-col-2');
        const QUIZ_MODAL = document.getElementById('quiz-modal');
        const CORRECT_ANSWER_TEXT = document.getElementById('correct-answer-text');
        const CORRECT_BUTTON = document.getElementById('correct-button');
        const WRONG_BUTTON = document.getElementById('wrong-button');
        const GAME_OVER_MODAL = document.getElementById('game-over-modal');
        const RESTART_GAME_BUTTON = document.getElementById('restart-game-button');
        const REMOTE_FILES_CONTAINER = document.getElementById('remote-files-container');
        
        const TIME_UP_MODAL = document.getElementById('time-up-modal');
        const TIME_UP_MESSAGE = document.getElementById('time-up-message');
        const TIME_UP_CONFIRM_BUTTON = document.getElementById('time-up-confirm-button');
        
        const REMOTE_CONTENT_BASE_URL = 'https://raw.githubusercontent.com/xaviuab/smart10/main/dades/';
        const GITHUB_API_URL = "https://api.github.com/repos/xaviuab/smart10/contents/dades";

        const ID_INDEX = 0;
        const QUESTION_INDEX = 1;
        const CATEGORY_INDEX = 2; 
        const OPTIONS_START_INDEX = 3; 
        const TOTAL_OPTIONS = 10;
        const WINNING_SCORE = 30;

        const TIMER_DISPLAY = document.getElementById('timer-display');
        const ENABLE_TIMER_CHECKBOX = document.getElementById('enable-timer-checkbox');
        const TOGGLE_TIMER_BUTTON = document.getElementById('toggle-timer-button');
        const TIMER_DURATION = 45; 
        const TIMER_WARNING = 10; 

        let csvData = [];
        let availableQuestionIndices = [];
        let players = [];
        let currentPlayerIndex = 0;
        let revealedOptionsCount = 0;
        
        let isTimerEnabled = false;
        let timerInterval = null;
        let timeLeft = TIMER_DURATION;


        // --- 1. L√íGICA DE CONFIGURACI√ì ---
        
        window.onload = () => {
            updatePlayerNameInputs(PLAYER_COUNT_SELECT.value);
            loadRemoteFilesList();
        };

        async function loadRemoteFilesList() {
            try {
                const response = await fetch(GITHUB_API_URL);
                if (!response.ok) throw new Error(`Error de xarxa: ${response.statusText}`);
                const files = await response.json();
                
                const csvFiles = files.filter(file => file.name.endsWith('.csv'));
                if (csvFiles.length === 0) {
                    REMOTE_FILES_CONTAINER.innerHTML = '<p class="text-white italic col-span-full">No s\'han trobat fitxers CSV.</p>';
                    return;
                }
                renderRemoteFilesList(csvFiles);
            } catch (error) {
                console.error("Error carregant la llista de fitxers remots:", error);
                REMOTE_FILES_CONTAINER.innerHTML = `<p class="text-red-300 italic col-span-full">Error al carregar fitxers: ${error.message}</p>`;
            }
        }

        function renderRemoteFilesList(files) {
            REMOTE_FILES_CONTAINER.innerHTML = ''; 
            files.forEach((file, index) => {
                const fileNameWithoutExtension = file.name.replace(/\.csv$/, '');
                const div = document.createElement('div');
                div.className = "flex items-center";
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `remote-file-${index}`;
                input.value = file.name;
                input.name = 'remote-files';
                input.className = 'h-5 w-5 rounded text-blue-600 focus:ring-blue-500';
                
                const label = document.createElement('label');
                label.htmlFor = `remote-file-${index}`;
                label.textContent = fileNameWithoutExtension;
                label.className = 'ml-2 text-white font-semibold cursor-pointer';
                
                div.appendChild(input);
                div.appendChild(label);
                REMOTE_FILES_CONTAINER.appendChild(div);
            });
        }

        PLAYER_COUNT_SELECT.addEventListener('change', (e) => {
            updatePlayerNameInputs(e.target.value);
        });

        function updatePlayerNameInputs(count) {
            PLAYER_NAMES_CONTAINER.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `player-name-${i}`;
                input.placeholder = `Nom del Jugador ${i}`;
                input.className = 'w-full p-3 rounded-lg bg-gray-100 text-gray-900 font-bold focus:outline-none focus:ring-4 focus:ring-amber-300';
                input.required = true;
                PLAYER_NAMES_CONTAINER.appendChild(input);
            }
        }

        SETUP_FORM.addEventListener('submit', async (e) => {
            e.preventDefault();
            await startGameSetup();
        });
        
        CSV_FILE_INPUT.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await startGameSetup(file);
            }
        });

        async function startGameSetup(localFile = null) {
            players = [];
            const playerCount = PLAYER_COUNT_SELECT.value;
            for (let i = 1; i <= playerCount; i++) {
                const name = document.getElementById(`player-name-${i}`).value || `Jugador ${i}`;
                players.push({ name: name, score: 0, currentRoundScore: 0, passed: false });
            }
            
            isTimerEnabled = ENABLE_TIMER_CHECKBOX.checked;
            updateTimerToggleButtonState(); 

            try {
                if (localFile) {
                    const text = await localFile.text();
                    csvData = parseCSV(text);
                } else {
                    const selectedFiles = document.querySelectorAll('input[name="remote-files"]:checked');
                    if (selectedFiles.length === 0) {
                        alert("Si us plau, selecciona almenys un conjunt de preguntes.");
                        return;
                    }
                    const fileNames = Array.from(selectedFiles).map(input => input.value);
                    csvData = await loadMultipleRemoteCSVs(fileNames);
                }

                if (csvData.length === 0) {
                    alert("No s'han pogut carregar les preguntes.");
                    return;
                }

                initializeQuestionPool();
                currentPlayerIndex = 0; 

                GAME_SETUP_AREA.classList.add('hidden');
                LOCAL_UPLOAD_AREA.classList.add('hidden');
                GAME_AREA.classList.remove('hidden');

                startQuiz();

            } catch (error) {
                console.error("Error durant la configuraci√≥ del joc:", error);
                alert(`Error en carregar les dades: ${error.message}`);
            }
        }
        
        async function loadMultipleRemoteCSVs(fileNames) {
            let combinedData = [];
            for (const fileName of fileNames) {
                try {
                    const response = await fetch(REMOTE_CONTENT_BASE_URL + fileName);
                    if (!response.ok) throw new Error(`No s'ha pogut carregar ${fileName}`);
                    const text = await response.text();
                    const data = parseCSV(text);
                    combinedData = combinedData.concat(data);
                } catch (error) {
                    console.warn(`No s'ha pogut carregar ${fileName}: ${error.message}`);
                }
            }
            return combinedData;
        }

        function parseCSV(text) {
            return text.split('\n')
                       .filter(row => row.trim() !== '')
                       .slice(1)
                       .map(row => row.split(';'));
        }

        function initializeQuestionPool() {
            availableQuestionIndices = Array.from({ length: csvData.length }, (_, i) => i);
            for (let i = availableQuestionIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableQuestionIndices[i], availableQuestionIndices[j]] = [availableQuestionIndices[j], availableQuestionIndices[i]];
            }
        }


        // --- 2. L√íGICA PRINCIPAL DEL JOC ---

        function startQuiz() {
            revealedOptionsCount = 0;
            players.forEach(player => {
                player.currentRoundScore = 0;
                player.passed = false;
            });

            if (availableQuestionIndices.length === 0) {
                alert("S'han acabat totes les preguntes disponibles!");
                endGame(true);
                return;
            }

            const questionIndex = availableQuestionIndices.pop();
            const questionData = csvData[questionIndex];

            OPTIONS_CONTAINER_1.innerHTML = '';
            OPTIONS_CONTAINER_2.innerHTML = '';

            if (!questionData || questionData.length < (OPTIONS_START_INDEX + TOTAL_OPTIONS * 2 - 1)) {
                console.error("Dades de pregunta inv√†lides:", questionData);
                startQuiz();
                return;
            }

            QUESTION_TEXT.textContent = questionData[QUESTION_INDEX];
            CATEGORY_DISPLAY.textContent = `Categoria: ${questionData[CATEGORY_INDEX]}`;

            let options = [];
            for (let i = 0; i < TOTAL_OPTIONS; i++) {
                const optionIndex = OPTIONS_START_INDEX + i * 2;
                const answerIndex = optionIndex + 1;
                options.push({
                    optionText: questionData[optionIndex],
                    answerText: questionData[answerIndex],
                    originalIndex: i
                });
            }
            shuffleArray(options); 

            options.forEach((opt, index) => {
                if (index < 5) {
                    OPTIONS_CONTAINER_1.appendChild(createOptionElement(opt, index, 'left'));
                } else {
                    OPTIONS_CONTAINER_2.appendChild(createOptionElement(opt, index, 'right'));
                }
            });

            currentPlayerIndex = (currentPlayerIndex) % players.length;
            
            updateScoreboard();
            updateTurnIndicator();
            startNewTurnTimer();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function createOptionElement(opt, id, position = 'left') {
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'flex items-center space-x-3';

            const text = document.createElement('span');
            text.className = 'flex-1 text-base font-bold text-yellow-300'; 
            text.textContent = opt.optionText;

            const button = document.createElement('button');
            button.id = `option-button-${id}`;
            button.className = 'answer-disc w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center'; 
            button.textContent = '?';
            button.onclick = () => revealAnswer(opt.answerText, button, position); 

            if (position === 'right') {
                text.classList.add('text-right');
                optionDiv.appendChild(button);
                optionDiv.appendChild(text);
            } else {
                text.classList.add('text-left');
                optionDiv.appendChild(text);
                optionDiv.appendChild(button);
            }
            
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'bg-red-900 bg-opacity-75 p-3 rounded-lg shadow-md'; 
            wrapperDiv.id = `option-container-${id}`;
            wrapperDiv.appendChild(optionDiv);

            return wrapperDiv;
        }


        /**
         * CANVIAT: L√≤gica de revelaci√≥ (w-auto, treu break-words)
         */
        function revealAnswer(answerText, buttonElement, position) {
            stopTimer();
            buttonElement.disabled = true;
            
            buttonElement.textContent = answerText;
            
            buttonElement.classList.remove('answer-disc');
            // CANVIAT: Treu w-10 (amplada fixa)
            buttonElement.classList.remove('text-white', 'text-2xl', 'w-10'); 
            
            buttonElement.classList.add(
                'bg-green-200',        // Verd claret
                'text-green-800',       // Verd fosc
                'text-sm',              // Mida de lletra per respostes
                'font-bold',
                'h-10',                 // Mateixa al√ßada
                'min-w-[2.5rem]',       // Amplada m√≠nima (com l'antic w-10)
                'w-auto',               // CANVIAT: Amplada autom√†tica
                'px-3',                 // Padding
                'shadow-inner',
                'rounded-lg'            // Arrodonit
                // ELIMINAT: 'break-words' (permet expansi√≥)
            );
            
            CORRECT_ANSWER_TEXT.textContent = answerText;
            QUIZ_MODAL.classList.remove('hidden');
            QUIZ_MODAL.dataset.answerText = answerText; 
            QUIZ_MODAL.dataset.buttonId = buttonElement.id;
        }
        
        PASS_TURN_BUTTON.addEventListener('click', () => {
            stopTimer();
            const currentPlayer = players[currentPlayerIndex];
            currentPlayer.score += currentPlayer.currentRoundScore;
            currentPlayer.currentRoundScore = 0;
            currentPlayer.passed = true;
            nextPlayer();
        });


        // --- 3. L√íGICA DE MODALS I TORN ---

        CORRECT_BUTTON.addEventListener('click', () => closeModal(true));
        WRONG_BUTTON.addEventListener('click', () => closeModal(false));

        TIME_UP_CONFIRM_BUTTON.addEventListener('click', () => {
            TIME_UP_MODAL.classList.add('hidden');
            
            const currentPlayer = players[currentPlayerIndex];
            currentPlayer.currentRoundScore = 0;
            currentPlayer.passed = true; 

            nextPlayer();
        });

        function closeModal(isCorrect) {
            QUIZ_MODAL.classList.add('hidden');
            const currentPlayer = players[currentPlayerIndex];
            
            const buttonId = QUIZ_MODAL.dataset.buttonId;
            const buttonElement = document.getElementById(buttonId);
            
            if (isCorrect) {
                currentPlayer.currentRoundScore += 1;
            } else {
                buttonElement.classList.remove('bg-green-200', 'text-green-800');
                buttonElement.classList.add('bg-red-200', 'text-red-800');
                
                currentPlayer.currentRoundScore = 0;
                currentPlayer.passed = true; 
            }
            
            revealedOptionsCount++;
            PASS_TURN_BUTTON.textContent = `Em planto (${currentPlayer.currentRoundScore})`;
            nextPlayer();
        }

        function nextPlayer() {
            if (revealedOptionsCount >= TOTAL_OPTIONS) {
                const lastPlayer = players[currentPlayerIndex];
                if (!lastPlayer.passed) {
                    lastPlayer.score += lastPlayer.currentRoundScore;
                }
                currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                endRound();
                return;
            }

            let nextPlayerIndex = -1;
            let searchCount = 0;
            let i = (currentPlayerIndex + 1) % players.length;

            while (searchCount < players.length) {
                if (!players[i].passed) {
                    nextPlayerIndex = i;
                    break;
                }
                i = (i + 1) % players.length;
                searchCount++;
            }

            if (nextPlayerIndex === -1) {
                endRound();
            } else {
                currentPlayerIndex = nextPlayerIndex;
                updateTurnIndicator();
                updateScoreboard();
                startNewTurnTimer();
            }
        }

        function endRound() {
            stopTimer();
            const maxScore = Math.max(...players.map(p => p.score));
            if (maxScore >= WINNING_SCORE) {
                endGame(false);
            } else {
                setTimeout(startQuiz, 1500);
            }
        }

        function endGame(isForced) {
            stopTimer();
            const winner = players.reduce((max, player) => player.score > max.score ? player : max, players[0]);
            
            if (isForced && availableQuestionIndices.length === 0) {
                document.getElementById('game-over-title').textContent = "S'han acabat les preguntes!";
                document.getElementById('game-over-winner').textContent = `El guanyador final √©s ${winner.name} amb ${winner.score} punts!`;
            } else {
                document.getElementById('game-over-winner').textContent = `El guanyador √©s ${winner.name} amb ${winner.score} punts!`;
            }
            GAME_OVER_MODAL.classList.remove('hidden');
        }

        RESTART_GAME_BUTTON.addEventListener('click', () => {
            window.location.reload();
        });


        // --- 4. L√íGICA D'INTERF√çCIE (UI) ---

        function updateScoreboard() {
            SCOREBOARD.innerHTML = '';
            const maxScore = Math.max(...players.map(p => p.score));

            players.forEach((player, index) => {
                const scoreSpan = document.createElement('span');
                let scoreText = `${player.name}: ${player.score}`;
                
                if (player.currentRoundScore > 0) {
                    scoreText += ` (+${player.currentRoundScore})`;
                }
                
                if (player.score === maxScore && maxScore > 0) {
                    scoreText = `üëë ${scoreText}`;
                }

                scoreSpan.textContent = scoreText;
                
                let styles = 'text-base font-bold py-2 px-4 rounded-full shadow-md transition-all duration-150';

                if (player.passed) {
                    styles += ' bg-red-900 text-red-300 line-through';
                } else if (index === currentPlayerIndex) {
                    styles += ' bg-green-700 text-green-200 border-2 border-yellow-300 transform scale-110 z-10';
                } else {
                    styles += ' bg-green-500 text-green-900';
                }
                
                scoreSpan.className = styles;
                SCOREBOARD.appendChild(scoreSpan);
            });
        }

        function updateTurnIndicator() {
            const player = players[currentPlayerIndex];
            if (player.passed) {
                TURN_INDICATOR.textContent = `${player.name} est√† fora de la ronda.`;
                TURN_INDICATOR.className = 'text-xl md:text-2xl font-extrabold text-red-400';
                PASS_TURN_BUTTON.classList.add('hidden'); 
            } else {
                TURN_INDICATOR.textContent = `Et toca, ${player.name}!`;
                TURN_INDICATOR.className = 'text-xl md:text-2xl font-extrabold text-orange-400';
                
                PASS_TURN_BUTTON.classList.remove('hidden');
                PASS_TURN_BUTTON.textContent = `Em planto (${player.currentRoundScore})`;
            }
        }
        
        // --- 5. FUNCIONS DEL TEMPORITZADOR ---
        
        TOGGLE_TIMER_BUTTON.addEventListener('click', () => {
            isTimerEnabled = !isTimerEnabled;
            updateTimerToggleButtonState();

            if (isTimerEnabled) {
                startNewTurnTimer();
            } else {
                stopTimer();
                TIMER_DISPLAY.classList.add('hidden');
            }
        });

        function updateTimerToggleButtonState() {
            if (isTimerEnabled) {
                TOGGLE_TIMER_BUTTON.classList.add('bg-red-600');
                TOGGLE_TIMER_BUTTON.classList.remove('bg-blue-600');
                TIMER_DISPLAY.classList.remove('hidden');
            } else {
                TOGGLE_TIMER_BUTTON.classList.add('bg-blue-600');
                TOGGLE_TIMER_BUTTON.classList.remove('bg-red-600');
                TIMER_DISPLAY.classList.add('hidden');
            }
        }

        function startNewTurnTimer() {
            stopTimer();
            if (!isTimerEnabled) return;

            timeLeft = TIMER_DURATION;
            updateTimerDisplay();
            TIMER_DISPLAY.classList.remove('timer-warning');

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= TIMER_WARNING) {
                    TIMER_DISPLAY.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            if (isTimerEnabled) {
                TIMER_DISPLAY.classList.remove('timer-warning');
            }
        }

        function updateTimerDisplay() {
            if (isTimerEnabled) {
                TIMER_DISPLAY.textContent = `${timeLeft}s`;
            }
        }

        function handleTimeUp() {
            stopTimer(); 
            const currentPlayer = players[currentPlayerIndex];
            
            TIME_UP_MESSAGE.textContent = `T'has quedat sense temps, ${currentPlayer.name}!`;
            TIME_UP_MODAL.classList.remove('hidden');
        }

    </script>
</body>
</html>
